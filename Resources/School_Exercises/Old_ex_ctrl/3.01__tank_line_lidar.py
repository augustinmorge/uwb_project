from math import atan, atan2
import numpy as np
import matplotlib.pyplot as plt
from numpy.linalg import det, norm

def draw_tank(x,col='darkblue',r=1,w=2):
    mx,my,θ=list(x[0:3,0])
    M = r*np.array([[1,-1,0,0,-1,-1,0,0,-1,1,0,0,3,3,0], [-2,-2,-2,-1,-1,1,1,2,2,2,2,1,0.5,-0.5,-1]])
    M = np.array([[1,0,mx],[0,1,my],[0,0,1]])@np.array([[np.cos(θ),-np.sin(θ),0],[np.sin(θ),np.cos(θ),0],[0,0,1]])@np.vstack((M,np.ones(M.shape[1])))
    plt.plot(M[0, :], M[1, :], col, w)   

def init_figure(xmin,xmax,ymin,ymax): 
    fig = plt.figure()
    ax = fig.add_subplot(111, aspect='equal')	
    ax.xmin=xmin
    ax.xmax=xmax
    ax.ymin=ymin
    ax.ymax=ymax
    clear(ax)
    return ax

def clear(ax):
    plt.pause(0.001)
    plt.cla()
    ax.set_xlim(ax.xmin,ax.xmax)
    ax.set_ylim(ax.ymin,ax.ymax)

def f(x,u):
    θ=x[2,0]
    return np.array([[np.cos(θ)], [np.sin(θ)],[u]])

def draw(ax,Path,i,indices_barrier,x):
    clear(ax)
    
    plt.plot(Path[:,0],Path[:,1],"purple")
    plt.scatter(Path[:,0],Path[:,1],c="purple")
    plt.scatter(indices_barrier[:,1],indices_barrier[:,0],c="black")
    
    draw_tank(x,'darkblue',r=0.4)
    plt.plot(Path[i:i+2,0],Path[i:i+2,1],"red")
    plt.scatter(Path[i:i+2,0],Path[i:i+2,1],c="red")
    
    plt.show()


def go(GAP,indices_barrier,Path,LENGHT,WIDTH):

    ax = init_figure(0,LENGHT/GAP,0,WIDTH/GAP)
    ax.invert_yaxis()
    
    
    x=np.array([[Path[0,0]],[Path[0,1]],[4]])
    dt= 0.1
    
    m = x[0:2]
    
        
    i = 0
    while i + 1 < len(Path) :
        
        a,b = np.array([Path[i]]).T, np.array([Path[i+1]]).T
        
        phi = atan2(b[1,0]-a[1,0], b[0,0]-a[0,0])
    
        while not (b-a).T@(b-m)<0 :
            
            draw(ax,Path,i,indices_barrier,x)
            
            e = det(np.hstack((b-a,m-a)))/norm(b-a)
            thetabar = phi - atan(e)
            u = atan(np.tan((thetabar - x[2,0])/2))
            
            x   = x+dt*f(x,u)
            
            m = x[0:2]
        
        i+=1

if __name__ == "__main__" :
    GAP = 12
    indices_barrier = np.array([[0, 90], [0, 114], [1, 87], [1, 88], [1, 89], [1, 136], [2, 85], [2, 86], [2, 87], [2, 123], [2, 125], [2, 126], [2, 127], [2, 128], [2, 129], [2, 134], [2, 135], [2, 136], [3, 82], [3, 83], [3, 84], [3, 99], [3, 101], [3, 103], [3, 104], [3, 105], [3, 106], [3, 107], [3, 108], [3, 109], [3, 110], [3, 111], [3, 112], [3, 113], [3, 114], [3, 115], [3, 116], [3, 117], [3, 118], [3, 119], [3, 120], [3, 121], [3, 122], [3, 123], [3, 124], [3, 125], [3, 126], [3, 127], [3, 128], [3, 130], [3, 134], [4, 81], [4, 82], [4, 85], [4, 86], [4, 87], [4, 88], [4, 89], [4, 90], [4, 91], [4, 92], [4, 93], [4, 94], [4, 95], [4, 96], [4, 97], [4, 98], [4, 99], [4, 100], [4, 101], [4, 102], [4, 103], [4, 104], [4, 105], [4, 106], [4, 107], [4, 108], [4, 109], [4, 110], [4, 111], [4, 112], [4, 113], [4, 114], [4, 115], [4, 116], [4, 130], [4, 131], [5, 67], [5, 68], [5, 72], [5, 73], [5, 74], [5, 75], [5, 76], [5, 77], [5, 78], [5, 79], [5, 80], [5, 81], [5, 82], [5, 83], [5, 84], [5, 85], [5, 86], [5, 87], [5, 88], [5, 89], [5, 90], [5, 91], [5, 92], [5, 93], [5, 94], [5, 95], [5, 96], [5, 97], [5, 98], [5, 99], [5, 100], [5, 130], [5, 132], [5, 134], [6, 67], [6, 68], [6, 69], [6, 70], [6, 71], [6, 72], [6, 73], [6, 74], [6, 75], [6, 76], [6, 77], [6, 78], [6, 79], [6, 98], [6, 99], [6, 100], [6, 134], [7, 67], [7, 68], [7, 73], [7, 74], [7, 75], [7, 76], [7, 77], [7, 98], [7, 99], [8, 67], [8, 68], [8, 71], [8, 72], [8, 73], [8, 74], [8, 75], [8, 76], [8, 77], [8, 98], [8, 102], [8, 134], [8, 135], [9, 66], [9, 67], [9, 69], [9, 85], [9, 87], [9, 98], [9, 104], [9, 119], [9, 120], [9, 132], [10, 67], [10, 85], [10, 87], [10, 98], [10, 119], [10, 120], [10, 121], [10, 122], [10, 132], [10, 133], [10, 134], [10, 135], [11, 67], [11, 79], [11, 85], [11, 86], [11, 119], [11, 120], [11, 121], [11, 122], [11, 124], [11, 127], [11, 135], [11, 136], [12, 67], [12, 78], [12, 79], [12, 97], [12, 98], [12, 119], [12, 120], [12, 121], [12, 124], [12, 130], [12, 132], [12, 134], [13, 67], [13, 96], [13, 97], [13, 98], [13, 120], [13, 129], [13, 130], [13, 132], [13, 135], [13, 137], [14, 67], [14, 69], [14, 79], [14, 80], [14, 94], [14, 96], [14, 97], [14, 120], [14, 121], [14, 122], [14, 123], [14, 124], [14, 125], [14, 126], [14, 127], [14, 130], [14, 135], [14, 136], [15, 66], [15, 67], [15, 72], [15, 77], [15, 78], [15, 79], [15, 80], [15, 81], [15, 86], [15, 87], [15, 88], [15, 89], [15, 90], [15, 91], [15, 92], [15, 93], [15, 94], [15, 95], [15, 96], [15, 120], [15, 121], [15, 124], [15, 125], [15, 126], [15, 127], [15, 130], [15, 131], [15, 132], [15, 133], [15, 135], [15, 136], [15, 138], [16, 67], [16, 68], [16, 77], [16, 78], [16, 79], [16, 80], [16, 81], [16, 93], [16, 94], [16, 124], [16, 125], [16, 126], [16, 127], [16, 128], [16, 129], [16, 130], [16, 132], [16, 133], [16, 134], [16, 135], [16, 136], [16, 137], [16, 138], [17, 67], [17, 79], [17, 80], [17, 81], [17, 124], [17, 126], [17, 127], [17, 128], [17, 129], [17, 130], [17, 131], [17, 132], [17, 135], [17, 136], [17, 137], [17, 138], [17, 139], [18, 67], [18, 74], [18, 77], [18, 78], [18, 79], [18, 80], [18, 81], [18, 82], [18, 126], [18, 127], [18, 128], [18, 136], [18, 137], [19, 67], [19, 69], [19, 72], [19, 73], [19, 74], [19, 75], [19, 76], [19, 77], [19, 78], [19, 80], [19, 81], [19, 82], [19, 136], [19, 137], [19, 138], [19, 139], [20, 67], [20, 76], [20, 77], [20, 78], [20, 81], [20, 137], [20, 138], [21, 67], [21, 68], [21, 75], [21, 76], [21, 77], [21, 78], [21, 137], [21, 138], [21, 139], [22, 67], [22, 68], [22, 76], [22, 77], [22, 137], [22, 138], [22, 139], [23, 67], [23, 68], [23, 132], [23, 137], [23, 138], [23, 139], [24, 67], [24, 68], [24, 70], [24, 71], [24, 72], [24, 73], [24, 133], [24, 134], [24, 137], [24, 138], [24, 139], [25, 66], [25, 67], [25, 68], [25, 73], [25, 133], [25, 134], [25, 137], [25, 138], [26, 67], [26, 68], [26, 109], [26, 121], [26, 122], [26, 123], [26, 137], [26, 138], [26, 139], [27, 67], [27, 68], [27, 70], [27, 121], [27, 123], [27, 132], [27, 137], [27, 138], [27, 139], [28, 67], [28, 68], [28, 92], [28, 93], [28, 94], [28, 111], [28, 112], [28, 113], [28, 117], [28, 118], [28, 120], [28, 121], [28, 125], [28, 126], [28, 132], [28, 135], [28, 137], [28, 138], [28, 139], [29, 67], [29, 68], [29, 93], [29, 94], [29, 95], [29, 105], [29, 110], [29, 111], [29, 112], [29, 115], [29, 117], [29, 118], [29, 132], [29, 133], [29, 135], [29, 137], [29, 138], [30, 67], [30, 68], [30, 85], [30, 86], [30, 87], [30, 88], [30, 90], [30, 91], [30, 92], [30, 93], [30, 94], [30, 95], [30, 110], [30, 112], [30, 113], [30, 116], [30, 132], [30, 137], [30, 138], [30, 139], [31, 67], [31, 68], [31, 132], [31, 138], [32, 67], [32, 68], [32, 74], [32, 84], [32, 95], [32, 96], [32, 97], [32, 138], [33, 67], [33, 68], [33, 84], [33, 95], [33, 97], [33, 104], [33, 105], [33, 132], [33, 135], [33, 137], [33, 138], [34, 67], [34, 68], [34, 73], [34, 84], [34, 96], [34, 104], [34, 105], [34, 130], [34, 131], [34, 132], [34, 133], [34, 135], [34, 136], [34, 138], [35, 68], [35, 71], [35, 104], [35, 105], [35, 116], [35, 117], [35, 130], [35, 131], [35, 132], [35, 133], [35, 135], [35, 138], [35, 139], [36, 67], [36, 68], [36, 70], [36, 71], [36, 72], [36, 73], [36, 100], [36, 101], [36, 102], [36, 115], [36, 116], [36, 130], [36, 131], [36, 138], [36, 139], [37, 68], [37, 69], [37, 73], [37, 82], [37, 83], [37, 99], [37, 100], [37, 101], [37, 102], [37, 117], [37, 130], [37, 131], [37, 132], [37, 134], [37, 135], [37, 136], [37, 137], [37, 138], [37, 139], [38, 68], [38, 69], [38, 70], [38, 72], [38, 73], [38, 82], [38, 83], [38, 93], [38, 96], [38, 100], [38, 101], [38, 102], [38, 112], [38, 113], [38, 114], [38, 115], [38, 116], [38, 117], [38, 118], [38, 119], [38, 120], [38, 121], [38, 122], [38, 123], [38, 124], [38, 125], [38, 126], [38, 130], [38, 131], [38, 132], [38, 134], [38, 135], [38, 136], [38, 137], [39, 69], [39, 70], [39, 72], [39, 82], [39, 83], [39, 90], [39, 93], [39, 94], [39, 95], [39, 96], [39, 97], [39, 98], [39, 99], [39, 100], [39, 101], [39, 102], [39, 103], [39, 104], [39, 105], [39, 106], [39, 107], [39, 108], [39, 109], [39, 110], [39, 111], [39, 112], [39, 113], [39, 114], [39, 115], [39, 116], [39, 117], [39, 118], [39, 119], [39, 120], [39, 124], [39, 128], [39, 130], [39, 131], [40, 69], [40, 72], [40, 76], [40, 77], [40, 78], [40, 79], [40, 80], [40, 81], [40, 82], [40, 83], [40, 84], [40, 85], [40, 86], [40, 87], [40, 88], [40, 89], [40, 90], [40, 91], [40, 92], [40, 93], [40, 94], [40, 95], [40, 96], [40, 97], [40, 98], [40, 99], [41, 6], [41, 7], [41, 8], [41, 12], [41, 13], [41, 14], [41, 15], [41, 16], [41, 17], [41, 18], [41, 19], [41, 20], [41, 21], [41, 22], [41, 23], [41, 24], [41, 25], [41, 26], [41, 27], [41, 28], [41, 29], [41, 30], [41, 31], [41, 32], [41, 33], [41, 34], [41, 35], [41, 36], [41, 37], [41, 38], [41, 39], [41, 40], [41, 41], [41, 42], [41, 43], [41, 44], [41, 45], [41, 46], [41, 47], [41, 48], [41, 49], [41, 50], [41, 51], [41, 52], [41, 53], [41, 54], [41, 55], [41, 56], [41, 57], [41, 58], [41, 59], [41, 60], [41, 61], [41, 62], [41, 63], [41, 64], [41, 65], [41, 66], [41, 67], [41, 68], [41, 69], [41, 70], [41, 71], [41, 72], [41, 76], [41, 77], [41, 78], [41, 79], [41, 80], [41, 81], [41, 82], [41, 83], [41, 87], [41, 88], [41, 89], [41, 90], [41, 91], [41, 92], [41, 93], [42, 4], [42, 5], [42, 6], [42, 7], [42, 8], [42, 9], [42, 10], [42, 11], [42, 12], [42, 13], [42, 14], [42, 15], [42, 16], [42, 17], [42, 18], [42, 19], [42, 20], [42, 21], [42, 22], [42, 23], [42, 24], [42, 25], [42, 26], [42, 27], [42, 28], [42, 29], [42, 30], [42, 31], [42, 32], [42, 80], [42, 81], [42, 85], [42, 139], [43, 80], [43, 81], [43, 82], [43, 138], [43, 139], [44, 80], [44, 81], [44, 82], [44, 129], [44, 130], [44, 139], [45, 80], [45, 81], [45, 122], [45, 123], [45, 129], [45, 130], [45, 139], [46, 80], [46, 81], [46, 123], [46, 129], [46, 139], [47, 80], [47, 81], [47, 125], [47, 126], [47, 139], [48, 68], [48, 69], [48, 70], [48, 71], [48, 72], [48, 73], [48, 74], [48, 75], [48, 76], [48, 77], [48, 78], [48, 79], [48, 80], [48, 81], [48, 82], [48, 139], [49, 68], [49, 69], [49, 70], [49, 71], [49, 72], [49, 73], [49, 74], [49, 75], [49, 80], [49, 81], [49, 125], [49, 139], [50, 22], [50, 23], [50, 24], [50, 25], [50, 26], [50, 28], [50, 29], [50, 30], [50, 31], [50, 32], [50, 33], [50, 34], [50, 35], [50, 36], [50, 37], [50, 38], [50, 39], [50, 40], [50, 41], [50, 42], [50, 43], [50, 44], [50, 45], [50, 46], [50, 47], [50, 48], [50, 49], [50, 68], [50, 72], [50, 73], [50, 80], [50, 81], [50, 82], [50, 139], [51, 34], [51, 49], [51, 68], [51, 72], [51, 78], [51, 79], [51, 139], [52, 34], [52, 49], [52, 68], [52, 72], [52, 139], [53, 34], [53, 49], [53, 68], [53, 81], [53, 123], [53, 124], [53, 139], [54, 34], [54, 35], [54, 49], [54, 139], [55, 0], [55, 1], [55, 6], [55, 7], [55, 9], [55, 10], [55, 11], [55, 12], [55, 13], [55, 14], [55, 15], [55, 16], [55, 17], [55, 21], [55, 22], [55, 23], [55, 24], [55, 25], [55, 26], [55, 27], [55, 28], [55, 29], [55, 30], [55, 31], [55, 32], [55, 33], [55, 34], [55, 35], [55, 49], [55, 139], [56, 1], [56, 2], [56, 8], [56, 49], [56, 139], [56, 140], [57, 1], [57, 49], [57, 64], [57, 65], [57, 66], [57, 67], [57, 68], [57, 69], [57, 84], [57, 139], [57, 140], [58, 49], [58, 76], [58, 84], [58, 85], [58, 139], [58, 140], [59, 49], [59, 50], [59, 68], [59, 76], [59, 83], [59, 84], [59, 85], [59, 139], [60, 49], [60, 66], [60, 67], [60, 68], [60, 70], [60, 71], [60, 72], [60, 77], [60, 78], [60, 79], [60, 85], [60, 140], [61, 66], [61, 67], [61, 68], [61, 76], [61, 77], [62, 68], [62, 76], [62, 77], [63, 68], [63, 76], [63, 77], [64, 49], [64, 50], [64, 68], [64, 76], [65, 49], [65, 50], [65, 68], [65, 69], [66, 49], [66, 50], [66, 68], [66, 69], [67, 49], [67, 50], [67, 68], [68, 49], [68, 50], [68, 68], [69, 49], [69, 50], [69, 68], [70, 50], [70, 68], [70, 69], [70, 134], [71, 50], [71, 68], [71, 69], [71, 133], [71, 134], [71, 135], [72, 49], [72, 50], [72, 68], [72, 69], [72, 135], [72, 139], [73, 50], [73, 68], [73, 69], [73, 126], [73, 127], [73, 128], [73, 129], [73, 130], [73, 131], [73, 132], [73, 133], [73, 134], [73, 136], [73, 137], [73, 139], [73, 140], [74, 64], [74, 65], [74, 66], [74, 68], [74, 69], [74, 115], [74, 116], [74, 119], [74, 120], [74, 121], [74, 124], [74, 126], [74, 129], [74, 132], [74, 133], [75, 49], [75, 50], [75, 66], [75, 68], [75, 69], [76, 49], [76, 50], [76, 68], [76, 69], [77, 54], [77, 55], [77, 57], [77, 58], [77, 60], [77, 62], [77, 63], [77, 68], [77, 69]])
    Path = 1/GAP * np.array([[696, 624], [708, 612], [720, 600], [732, 588], [744, 576], [756, 564], [768, 552], [780, 540], [792, 540], [804, 540], [816, 528], [828, 528], [840, 528], [852, 528], [864, 528], [876, 516], [888, 504], [888, 492], [888, 480], [900, 468], [912, 456], [924, 444], [936, 432], [948, 420], [960, 408], [972, 396], [972, 384], [972, 372], [984, 360], [996, 348], [1008, 336], [1020, 324], [1032, 312], [1044, 300], [1056, 288], [1068, 276], [1080, 264], [1092, 252], [1104, 252], [1116, 252], [1128, 252], [1140, 252], [1152, 252], [1164, 252], [1176, 252], [1188, 252], [1200, 252], [1212, 252], [1224, 252], [1236, 252], [1248, 252], [1260, 252], [1272, 252], [1284, 252], [1296, 252], [1308, 252], [1320, 252], [1332, 252], [1344, 252], [1356, 252], [1368, 252], [1380, 252], [1392, 252], [1404, 252], [1416, 252], [1428, 252], [1440, 252], [1452, 252]])
    LENGHT, WIDTH = (1692, 948)
    
    go(GAP,indices_barrier,Path,LENGHT,WIDTH)